---
phase: 01-apk-parity-release-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - "zero-auth-wallet/app/approve-request.tsx"
  - "zero-auth-wallet/lib/revocation.ts"
autonomous: true

must_haves:
  truths:
    - "User can check if credential is revoked before presenting"
    - "Verification flow checks revocation status"
    - "User sees warning if credential is revoked"
  artifacts:
    - path: "zero-auth-wallet/lib/revocation.ts"
      provides: "Revocation status check utilities"
  key_links:
    - from: "approve-request.tsx"
      to: "revocation.ts"
      via: "checkRevocationStatus() call"
---
<objective>
Add revocation status verification before proof presentation (SEC-04).

Purpose: Users must be able to check if their credentials are still valid before presenting proofs
Output: Revocation check integrated into verification flow
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@zero-auth-wallet/app/approve-request.tsx
@zero-auth-wallet/store/auth-store.ts
</context>

<tasks>

<task type="auto">
  <name>Create revocation check utilities</name>
  <files>zero-auth-wallet/lib/revocation.ts</files>
  <action>
    Create module for revocation status checking:
    
    ```typescript
    // zero-auth-wallet/lib/revocation.ts
    import { Credential } from '@/store/auth-store';
    
    /**
     * Checks revocation status for a credential.
     * In production, this would call a revocation registry.
     * For MVP, checks local revocationId and status.
     * 
     * Returns: { isRevoked: boolean, status: 'valid' | 'revoked' | 'unknown' }
     */
    export async function checkRevocationStatus(
      credential: Credential
    ): Promise<{ isRevoked: boolean; status: 'valid' | 'revoked' | 'unknown' }> {
      // For MVP: check if credential has revocationId
      // In production: query revocation registry
      
      if (!credential.revocationId) {
        // No revocation tracking - assume valid
        return { isRevoked: false, status: 'valid' };
      }
      
      // TODO: In Phase 2/3, integrate with revocation registry
      // For now, return valid if we can't check
      return { isRevoked: false, status: 'valid' };
    }
    
    /**
     * Gets cached revocation status (for offline mode)
     */
    export function getCachedRevocationStatus(credentialId: string): 'valid' | 'revoked' | 'unknown' {
      // Check AsyncStorage for cached status
      return 'unknown';
    }
    ```
  </action>
  <verify>
    File created with checkRevocationStatus function
  </verify>
  <done>
    Revocation utilities created
  </done>
</task>

<task type="auto">
  <name>Integrate revocation check into approval flow</name>
  <files>zero-auth-wallet/app/approve-request.tsx</files>
  <action>
    Modify approve-request.tsx to check revocation status before allowing proof generation:
    
    1. Import checkRevocationStatus from @/lib/revocation
    2. In handleApprove, before generating proof:
       - Call checkRevocationStatus(matchingCredential)
       - If isRevoked, show error and prevent proof generation
       - If status is 'unknown', show warning but allow proceeding
    
    3. Add UI indicator showing credential validity status
  </action>
  <verify>
    Revocation check runs before proof generation
  </verify>
  <done>
    Approval flow includes revocation status check
  </done>
</task>

</tasks>

<verification>
1. Revocation check runs during verification approval
2. Revoked credentials cannot be used for proofs
3. User sees clear status indication
</verification>

<success_criteria>
- [ ] checkRevocationStatus function exists
- [ ] Approval flow checks status before generating proof
- [ ] Clear user feedback on revocation status
</success_criteria>

<output>
After completion, create `.planning/phases/01-apk-parity-release-hardening/01-03-SUMMARY.md`
</output>
