---
phase: 01-apk-parity-release-hardening
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - "zero-auth-wallet/lib/offline.ts"
  - "zero-auth-wallet/store/wallet-store.ts"
  - "zero-auth-wallet/app/(tabs)/index.tsx"
autonomous: true

must_haves:
  truths:
    - "App detects when offline"
    - "User can view cached credentials offline"
    - "Actions queue for when connection restores"
    - "User sees offline indicator"
  artifacts:
    - path: "zero-auth-wallet/lib/offline.ts"
      provides: "Network detection and action queue"
  key_links:
    - from: "index.tsx"
      to: "offline.ts"
      via: "useNetworkStatus hook"
---
<objective>
Implement offline detection and graceful degradation (SEC-05).

Purpose: App should work when offline - show cached data, queue actions for later
Output: Offline-aware wallet with action queuing
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@zero-auth-wallet/store/auth-store.ts
@zero-auth-wallet/app/(tabs)/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Create offline detection utilities</name>
  <files>zero-auth-wallet/lib/offline.ts</files>
  <action>
    Create module for network detection and action queuing:
    
    ```typescript
    // zero-auth-wallet/lib/offline.ts
    import NetInfo from '@react-native-community/netinfo';
    import AsyncStorage from '@react-native-async-storage/async-storage';
    
    export type QueuedAction = {
      id: string;
      type: 'ADD_CREDENTIAL' | 'REVOKE_CREDENTIAL';
      payload: any;
      timestamp: number;
    };
    
    const QUEUED_ACTIONS_KEY = 'offline_queue';
    
    /**
     * Get current network status
     */
    export async function getNetworkStatus(): Promise<boolean> {
      const state = await NetInfo.fetch();
      return state.isConnected ?? false;
    }
    
    /**
     * Queue action for later when offline
     */
    export async function queueAction(action: Omit<QueuedAction, 'id' | 'timestamp'>): Promise<void> {
      const existing = await getQueuedActions();
      const newAction: QueuedAction = {
        ...action,
        id: Math.random().toString(36).substring(7),
        timestamp: Date.now(),
      };
      await AsyncStorage.setItem(QUEUED_ACTIONS_KEY, JSON.stringify([...existing, newAction]));
    }
    
    /**
     * Get all queued actions
     */
    export async function getQueuedActions(): Promise<QueuedAction[]> {
      const stored = await AsyncStorage.getItem(QUEUED_ACTIONS_KEY);
      return stored ? JSON.parse(stored) : [];
    }
    
    /**
     * Process queued actions when back online
     */
    export async function processQueuedActions(): Promise<void> {
      const actions = await getQueuedActions();
      // Process each action
      for (const action of actions) {
        try {
          // Execute based on type
          console.log('Processing queued action:', action.type);
        } catch (e) {
          console.error('Failed to process action:', action.id, e);
        }
      }
      // Clear queue after processing
      await AsyncStorage.removeItem(QUEUED_ACTIONS_KEY);
    }
    ```
  </action>
  <verify>
    File created with network detection and queue functions
  </verify>
  <done>
    Offline utilities created
  </done>
</task>

<task type="auto">
  <name>Add network status hook</name>
  <files>zero-auth-wallet/lib/offline.ts</files>
  <action>
    Add React hook for network status monitoring:
    
    ```typescript
    import { useEffect, useState } from 'react';
    import NetInfo, { NetInfoState } from '@react-native-community/netinfo';
    
    export function useNetworkStatus() {
      const [isOnline, setIsOnline] = useState(true);
      const [isChecking, setIsChecking] = useState(true);
    
      useEffect(() => {
        const unsubscribe = NetInfo.addEventListener((state: NetInfoState) => {
          setIsOnline(state.isConnected ?? false);
          setIsChecking(false);
          
          // Process queued actions when coming back online
          if (state.isConnected) {
            processQueuedActions();
          }
        });
    
        return () => unsubscribe();
      }, []);
    
      return { isOnline, isChecking };
    }
    ```
  </action>
  <verify>
    useNetworkStatus hook available
  </verify>
  <done>
    Network status hook created
  </done>
</task>

<task type="auto">
  <name>Add offline indicator to home screen</name>
  <files>zero-auth-wallet/app/(tabs)/index.tsx</files>
  <action>
    Update home screen to show offline status and queue actions:
    
    1. Import useNetworkStatus from @/lib/offline
    2. Add offline banner at top of screen when isOnline is false
    3. Show cached credentials (already works via zustand persist)
    4. Disable actions that require network (add credential), show "available when online"
    
    Example banner:
    ```tsx
    {!isOnline && (
      <View className="bg-yellow-500/20 px-4 py-2">
        <Text className="text-yellow-500 text-center text-sm">
          You're offline. Some features limited.
        </Text>
      </View>
    )}
    ```
  </action>
  <verify>
    Offline banner appears when disconnected
  </verify>
  <done>
    Offline indicator visible on home screen
  </done>
</task>

<task type="auto">
  <name>Integrate action queuing with credential operations</name>
  <files>zero-auth-wallet/store/auth-store.ts</files>
  <action>
    Modify credential operations to queue when offline:
    
    1. In addCredential: check isOnline, if false queue the add
    2. In removeCredential: check isOnline, if false queue the revoke
    
    Update auth-store.ts to import queueAction and check network status.
  </action>
  <verify>
    Actions queue when offline, process when back online
  </verify>
  <done>
    Credential operations queue offline
  </done>
</task>

</tasks>

<verification>
1. Offline banner shows when disconnected
2. Credentials viewable offline (via zustand persist)
3. Add/revoke queue when offline
4. Queue processes when connection restores
</verification>

<success_criteria>
- [ ] Offline state detected and displayed
- [ ] Cached credentials viewable offline
- [ ] Actions queue for later execution
- [ ] Queue processes automatically when online
</success_criteria>

<output>
After completion, create `.planning/phases/01-apk-parity-release-hardening/01-04-SUMMARY.md`
</output>
